<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4F46E5">
    <title>QR Attendance System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: #0f172a; color: #fff; padding-bottom: 20px; }
        .container { max-width: 100%; padding: 16px; }
        .header { text-align: center; margin-bottom: 24px; padding-top: 8px; }
        .header h1 { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
        .header p { font-size: 13px; color: #94a3b8; }
        
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; background: #1e293b; padding: 8px; border-radius: 12px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; color: #94a3b8; font-weight: 600; cursor: pointer; border-radius: 8px; transition: all 0.3s; }
        .tab-btn.active { background: #4f46e5; color: #fff; }
        
        .tab { display: none; }
        .tab.active { display: block; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #cbd5e1; text-transform: uppercase; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #334155; background: #1e293b; color: #fff; border-radius: 8px; font-size: 16px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-primary { background: #4f46e5; color: #fff; }
        .btn-primary:active { transform: scale(0.98); background: #4338ca; }
        .btn-success { background: #10b981; color: #fff; }
        .btn-success:active { transform: scale(0.98); background: #059669; }
        .btn-danger { background: #ef4444; color: #fff; }
        .btn-secondary { background: #64748b; color: #fff; }
        
        .qr-container { background: #1e293b; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 16px; border: 2px dashed #4f46e5; }
        #qrcode { display: inline-block; padding: 16px; background: #0f172a; border-radius: 8px; }
        #qrcode canvas { max-width: 100%; }
        .qr-timer { color: #f97316; font-weight: 600; margin-top: 12px; font-size: 13px; }
        
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .stat-card { background: #1e293b; padding: 16px; border-radius: 8px; text-align: center; border-left: 4px solid #4f46e5; }
        .stat-value { font-size: 24px; font-weight: 700; color: #4f46e5; }
        .stat-label { font-size: 12px; color: #94a3b8; margin-top: 4px; text-transform: uppercase; }
        
        .attendance-list { background: #1e293b; border-radius: 12px; overflow: hidden; max-height: 400px; overflow-y: auto; }
        .attendance-item { padding: 12px 16px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
        .attendance-item:last-child { border-bottom: none; }
        .student-info { flex: 1; }
        .student-roll { font-size: 12px; color: #94a3b8; }
        .student-name { font-weight: 600; margin-top: 4px; }
        .student-time { font-size: 12px; color: #4f46e5; }
        .delete-btn { background: #ef4444; color: #fff; border: none; padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; }
        
        .message { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-weight: 600; font-size: 14px; }
        .message.success { background: #10b981; color: #ecfdf5; }
        .message.error { background: #ef4444; color: #fef2f2; }
        .message.info { background: #3b82f6; color: #eff6ff; }
        
        .copy-btn { background: #64748b; color: #fff; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; margin-top: 8px; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: #1e293b; padding: 24px; border-radius: 12px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { font-size: 20px; font-weight: 700; margin-bottom: 16px; }
        .modal-close { float: right; font-size: 24px; cursor: pointer; color: #94a3b8; }
        
        .empty-state { text-align: center; padding: 32px 16px; color: #94a3b8; }
        .empty-icon { font-size: 48px; margin-bottom: 16px; }
        
        .subject-badge { display: inline-block; background: #4f46e5; color: #fff; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        
        .firebase-status { position: fixed; top: 10px; right: 10px; padding: 8px 12px; border-radius: 8px; font-size: 11px; font-weight: 600; z-index: 999; }
        .firebase-status.connected { background: #10b981; color: #fff; }
        .firebase-status.disconnected { background: #ef4444; color: #fff; }
        
        .info-button { position: fixed; bottom: 16px; right: 16px; width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, #4f46e5, #8b5cf6); color: #fff; border: none; font-size: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4); z-index: 999; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .info-button:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(79, 70, 229, 0.6); }
        .info-button:active { transform: scale(0.95); }
        
        .info-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: none; align-items: center; justify-content: center; z-index: 1001; }
        .info-modal.active { display: flex; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .info-content { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 32px; border-radius: 16px; width: 90%; max-width: 400px; text-align: center; border: 2px solid #4f46e5; box-shadow: 0 8px 32px rgba(79, 70, 229, 0.5); animation: slideUp 0.3s; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .info-content .emoji { font-size: 48px; margin-bottom: 16px; animation: wave 2s infinite; display: inline-block; }
        @keyframes wave { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(20deg); } 75% { transform: rotate(-20deg); } }
        .info-content h3 { color: #fff; margin-bottom: 12px; font-size: 20px; }
        .info-content .dev-name { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 800; font-size: 24px; letter-spacing: 1px; margin: 16px 0; }
        .info-content .heart { color: #ef4444; animation: heartbeat 1.2s infinite; display: inline-block; font-size: 20px; }
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 10%, 30% { transform: scale(1.3); } 20%, 40% { transform: scale(1.1); } }
        .info-content p { color: #94a3b8; margin: 8px 0; font-size: 14px; }
        .info-content .cute-icons { display: flex; justify-content: center; gap: 8px; margin: 16px 0; font-size: 20px; }
        .info-content .cute-icons span { animation: bounce 2s infinite; display: inline-block; }
        .info-content .cute-icons span:nth-child(1) { animation-delay: 0s; }
        .info-content .cute-icons span:nth-child(2) { animation-delay: 0.2s; }
        .info-content .cute-icons span:nth-child(3) { animation-delay: 0.4s; }
        .info-content .cute-icons span:nth-child(4) { animation-delay: 0.6s; }
        .info-content .cute-icons span:nth-child(5) { animation-delay: 0.8s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .info-close { margin-top: 20px; background: #4f46e5; color: #fff; border: none; padding: 10px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .info-close:hover { background: #4338ca; transform: translateY(-2px); }
    </style>
</head>
<body>
    <div id="firebase-status" class="firebase-status disconnected">‚ö†Ô∏è Connecting...</div>
    
    <div class="container">
        <div class="header">
            <h1>üì± Attendance System</h1>
            <p>Firebase-Powered QR Attendance</p>
        </div>

        <!-- TEACHER TAB -->
        <div id="teacher-tab" class="tab active">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('teacher-tab', event)">Teacher</button>
                <button class="tab-btn" onclick="switchTab('history-tab', event)">History</button>
            </div>

            <div class="form-group">
                <label>Select Subject</label>
                <select id="subject-select" onchange="onSubjectChange()">
                    <option value="">-- Choose Subject --</option>
                </select>
            </div>

            <button class="btn btn-primary" onclick="generateQRCode()">üì≤ Generate QR Code</button>

            <div id="qr-section" style="display: none; margin-top: 20px;">
                <div class="qr-container">
                    <div id="qrcode"></div>
                    <div class="qr-timer" id="qr-timer"></div>
                </div>
                <div style="background: #1e293b; padding: 12px; border-radius: 8px; margin-bottom: 12px; word-break: break-all; font-size: 12px;">
                    <div id="qr-link" style="color: #94a3b8;"></div>
                </div>
                <button class="btn btn-secondary" onclick="copyQRLink()">üìã Copy Link</button>
                <button class="btn btn-danger" onclick="resetQR()" style="margin-top: 8px;">‚úï Clear QR</button>
            </div>

            <div style="margin-top: 24px;">
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="present-count">0</div>
                        <div class="stat-label">Present</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-count">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                </div>

                <h3 style="margin-bottom: 12px; font-size: 16px;">Today's Attendance</h3>
                <div id="attendance-list-container" class="attendance-list">
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <div>Select a subject to see attendance</div>
                    </div>
                </div>

                <button class="btn btn-success" onclick="downloadAttendance()" style="margin-top: 16px;">üìä Download Excel</button>
            </div>
        </div>

        <!-- HISTORY TAB -->
        <div id="history-tab" class="tab">
            <div class="tabs">
                <button class="tab-btn" onclick="switchTab('teacher-tab', event)">Teacher</button>
                <button class="tab-btn active" onclick="switchTab('history-tab', event)">History</button>
            </div>
            <h2 style="margin-bottom: 16px; font-size: 18px; margin-top: 16px;">Attendance History</h2>
            <div id="history-container"></div>
        </div>
    </div>

    <!-- INFO BUTTON -->
    <button class="info-button" onclick="openInfoModal()">‚ÑπÔ∏è</button>

    <!-- INFO MODAL -->
    <div id="info-modal" class="info-modal">
        <div class="info-content">
            <div class="emoji">üë®‚Äçüíª</div>
            <h3>Crafted with <span class="heart">‚ù§Ô∏è</span></h3>
            <div class="dev-name">Shivam Kumar Mahto</div>
            <div class="cute-icons">
                <span>‚≠ê</span>
                <span>‚ú®</span>
                <span>üí´</span>
                <span>üåü</span>
                <span>‚ö°</span>
            </div>
            <p>¬© 2025 ‚Ä¢ Made with passion & code</p>
            <button class="info-close" onclick="closeInfoModal()">Close</button>
        </div>
    </div>

    <!-- STUDENT MODAL -->
    <div id="student-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h2 style="margin-bottom: 20px;">Mark Attendance</h2>
            <div class="form-group">
                <label>Subject</label>
                <input type="text" id="modal-subject" disabled>
            </div>
            <div class="form-group">
                <label>Your Roll Number</label>
                <input type="text" id="student-roll" placeholder="e.g., 25/B09/001" autocomplete="off">
            </div>
            <button class="btn btn-success" onclick="submitAttendance()">‚úì Submit Attendance</button>
            <div id="modal-message" style="margin-top: 16px;"></div>
        </div>
    </div>

    <script>
        // ============ FIREBASE CONFIGURATION ============
        const firebaseConfig = {
            apiKey: "AIzaSyAqe1sudjw-ATS_bv7f3pNyqAK_sw26cr4",
            authDomain: "qr-attendance-system-a8a8a.firebaseapp.com",
            databaseURL: "https://qr-attendance-10d7d-default-rtdb.firebaseio.com",
            projectId: "qr-attendance-system-a8a8a",
            storageBucket: "qr-attendance-system-a8a8a.firebasestorage.app",
            messagingSenderId: "81759182063",
            appId: "1:81759182063:web:37f3ec343d251c30dd191a",
            measurementId: "G-MTRXR9QHK0"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Connection status
        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', (snap) => {
            const statusEl = document.getElementById('firebase-status');
            if (snap.val() === true) {
                statusEl.textContent = '‚úì Connected';
                statusEl.className = 'firebase-status connected';
            } else {
                statusEl.textContent = '‚ö†Ô∏è Offline';
                statusEl.className = 'firebase-status disconnected';
            }
        });

        // ============ APP DATA ============
        const SUBJECTS = [
            { code: "AM101", name: "MATHEMATICS-1" },
            { code: "AP101", name: "PHYSICS" },
            { code: "CE101", name: "BASIC CIVIL ENGINEERING" },
            { code: "EE101", name: "BASIC ELECTRICAL ENGINEERING-1" },
            { code: "ME103", name: "WORKSHOP PRACTICE" },
            { code: "AECVAC", name: "AEC/VAC Course" }
        ];

        const STUDENTS = [
            { rollNo: "25/B09/001", name: "AADISHRI KHER" }, { rollNo: "25/B09/002", name: "AAKRITI SAXENA" },
            { rollNo: "25/B09/003", name: "AARAV" }, { rollNo: "25/B09/006", name: "AAYUSH BAHUGUNA" },
            { rollNo: "25/B09/007", name: "AAYUSH KUMAR" }, { rollNo: "25/B09/008", name: "ABHINADAN YADAV" },
            { rollNo: "25/B09/010", name: "ABHINAV KUMAR SINGH" }, { rollNo: "25/B09/011", name: "ABHINAV SHARMA" },
            { rollNo: "25/B09/012", name: "ABHISHEK KARHANA" }, { rollNo: "25/B09/013", name: "ABHISHEK KUMAR" },
            { rollNo: "25/B09/014", name: "ABHISHEK KUMAR" }, { rollNo: "25/B09/015", name: "ABHYUDAYA SHARMA" },
            { rollNo: "25/B09/016", name: "ADARSH RATHOD" }, { rollNo: "25/B09/017", name: "ADITYA GOYAL" },
            { rollNo: "25/B09/018", name: "ADITYA KUMAR" }, { rollNo: "25/B09/019", name: "ADITYA KUMAR" },
            { rollNo: "25/B09/020", name: "ADITYA RAJ" }, { rollNo: "25/B09/021", name: "ADITYARADITYA KANOJIA" },
            { rollNo: "25/B09/022", name: "AKHAND PRATAP SINGH" }, { rollNo: "25/B09/024", name: "AKSHIT KUMAR" },
            { rollNo: "25/B09/025", name: "AMAN KUMAR" }, { rollNo: "25/B09/026", name: "AMAN YADAV" },
            { rollNo: "25/B09/027", name: "AMARTYA SINHA" }, { rollNo: "25/B09/028", name: "AMIT GOSWAMI" },
            { rollNo: "25/B09/030", name: "ANAND KUMAR GUPTA" }, { rollNo: "25/B09/031", name: "ANAS MALIK" },
            { rollNo: "25/B09/032", name: "ANIKET" }, { rollNo: "25/B09/034", name: "ANIMESH KUMAR MISHRA" },
            { rollNo: "25/B09/035", name: "ANIRUDH CHAKRABORTY" }, { rollNo: "25/B09/036", name: "ANIRUDH CHAUHAN" },
            { rollNo: "25/B09/038", name: "ANSHUMAN BHASKAR" }, { rollNo: "25/B09/039", name: "ANUBHAV RAJPUT" },
            { rollNo: "25/B09/040", name: "ARNAV KUMAR" }, { rollNo: "25/B09/041", name: "ARPAN GUPTA" },
            { rollNo: "25/B09/042", name: "ARPIT AGGARWAL" }, { rollNo: "25/B09/043", name: "ARSH TANWAR" },
            { rollNo: "25/B09/044", name: "ARUSH GUPTA" }, { rollNo: "25/B09/045", name: "ARYA SINGH" },
            { rollNo: "25/B09/046", name: "ARYAMAN BHATNAGAR" }, { rollNo: "25/B09/047", name: "ARYAN RATHEE" },
            { rollNo: "25/B09/048", name: "ARYAN SHENDE" }, { rollNo: "25/B09/050", name: "ASHISH ANAND" },
            { rollNo: "25/B09/052", name: "ATHARV RASTOGI" }, { rollNo: "25/B09/053", name: "ATHARV SINGH" },
            { rollNo: "25/B09/055", name: "AVANINDRA PRATAP SINGH" }, { rollNo: "25/B09/056", name: "AYUSH" },
            { rollNo: "25/B09/057", name: "AYUSH" }, { rollNo: "25/B09/058", name: "AYUSH KUMAR SINGH" },
            { rollNo: "25/B09/059", name: "BHAVISHAY GOYAL" }, { rollNo: "25/B09/061", name: "BOBBY KUMAR" },
            { rollNo: "25/B09/062", name: "CHARANJEET SINGH" }, { rollNo: "25/B09/063", name: "CHARCHIT PARASHAR" },
            { rollNo: "25/B09/065", name: "CHIRAG SINGH JADON" }, { rollNo: "25/B09/066", name: "CHIRJIV SINGH" },
            { rollNo: "25/B09/067", name: "CHITKARSH MALIK" }, { rollNo: "25/B09/069", name: "DAKSH" },
            { rollNo: "25/B09/071", name: "DAKSH CHOUDHARY" }, { rollNo: "25/B09/072", name: "DAKSH GARG" },
            { rollNo: "25/B09/073", name: "DAKSH SINGH" }, { rollNo: "25/B09/074", name: "DAKSH TIWARI" },
            { rollNo: "25/B09/075", name: "DEEP NARYAN" }, { rollNo: "25/B09/077", name: "DEEPANSHU KUMAR MEENA" },
            { rollNo: "25/B09/078", name: "DEV CHOUDHARY" }, { rollNo: "25/B09/080", name: "ADVAITH RAMESH PILLAI" },
            { rollNo: "25/B09/081", name: "ADVAITH SALIL PILLAI" }, { rollNo: "25/B09/082", name: "AYAAZ OMAR" },
            { rollNo: "25/B13/077", name: "YASH AGARWAL" }, { rollNo: "25/B13/011", name: "ANKIT KUMAR JHA" },
            { rollNo: "25/B14/001", name: "AARYA SINGH" }, { rollNo: "25/B14/077", name: "ADITYA AGRAWAL" },
            { rollNo: "25/B08/058", name: "YASH PRATAP SINGH" }, { rollNo: "25/B13/034", name: "MAULIK JAIN" },
            { rollNo: "25/B15/079", name: "VIVEK TOMAR" }, { rollNo: "25/B13/008", name: "AISHWARY TIWARI" },
            { rollNo: "25/B16/051", name: "KAUSHAL" }, { rollNo: "25/B13/021", name: "DAKSH TOMAR" },
            { rollNo: "25/B15/026", name: "HONEY BAGHEL" }, { rollNo: "25/B08/045", name: "TANEK JAIN" },
            { rollNo: "25/B13/029", name: "KSHITIJ SINGH" }, { rollNo: "25/B16/063", name: "MUKUL SHARMA" },
            { rollNo: "25/B13/073", name: "VANSH NATHANI" }, { rollNo: "25/B13/074", name: "VIKASH KUMAR" },
            { rollNo: "25/B15/035", name: "MAYANK SAHUROY" }, { rollNo: "25/B14/069", name: "TIJIL ARORA" },
            { rollNo: "25/B13/065", name: "SANYAM" }, { rollNo: "25/B15/034", name: "MANVENDRA SINGH" }
        ];

        let currentSubject = null;
        let currentQRCode = null;
        let qrExpireTime = null;

        function initializeApp() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (code) {
                const [date, subject] = code.split('_');
                const subj = SUBJECTS.find(s => s.code === subject);
                if (subj) {
                    document.getElementById('modal-subject').value = subj.name;
                    document.getElementById('student-modal').classList.add('active');
                    document.getElementById('student-roll').focus();
                }
            } else {
                populateSubjects();
                renderHistory();
            }
        }

        function populateSubjects() {
            const select = document.getElementById('subject-select');
            SUBJECTS.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.code;
                opt.textContent = `${s.code} - ${s.name}`;
                select.appendChild(opt);
            });
        }

        function onSubjectChange() {
            const code = document.getElementById('subject-select').value;
            currentSubject = SUBJECTS.find(s => s.code === code);
            resetQR();
            updateAttendanceDisplay();
        }

        function generateQRCode() {
            if (!currentSubject) {
                alert('Please select a subject first');
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            const code = `${today}_${currentSubject.code}`;
            
            const baseURL = window.location.origin + window.location.pathname;
            const url = `${baseURL}?code=${code}`;

            currentQRCode = { code, url, time: Date.now() };
            qrExpireTime = Date.now() + (10 * 60 * 1000);

            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById('qrcode'), {
                text: url,
                width: 200,
                height: 200,
                colorDark: "#ffffff",
                colorLight: "#1e293b"
            });

            document.getElementById('qr-link').textContent = url;
            document.getElementById('qr-section').style.display = 'block';
            startQRTimer();
        }

        function startQRTimer() {
            const timer = setInterval(() => {
                const now = Date.now();
                const remaining = Math.max(0, Math.floor((qrExpireTime - now) / 1000));
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                document.getElementById('qr-timer').textContent = `Expires in ${mins}:${String(secs).padStart(2, '0')}`;

                if (remaining <= 0) {
                    clearInterval(timer);
                    resetQR();
                }
            }, 1000);
        }

        function resetQR() {
            document.getElementById('qr-section').style.display = 'none';
            document.getElementById('qrcode').innerHTML = '';
            currentQRCode = null;
        }

        function copyQRLink() {
            const link = document.getElementById('qr-link').textContent;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(link).then(() => {
                    alert('‚úì Link copied to clipboard!');
                }).catch(() => {
                    alert('Could not copy. Link: ' + link);
                });
            }
        }

        function updateAttendanceDisplay() {
            if (!currentSubject) {
                document.getElementById('attendance-list-container').innerHTML = '<div class="empty-state"><div class="empty-icon">üìã</div><div>Select a subject to see attendance</div></div>';
                document.getElementById('present-count').textContent = '0';
                document.getElementById('total-count').textContent = STUDENTS.length;
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            const key = `${today}_${currentSubject.code}`;

            database.ref('attendance/' + key).on('value', (snapshot) => {
                const data = snapshot.val();
                const todayAttendance = data ? Object.values(data) : [];

                let html = '';
                if (todayAttendance.length === 0) {
                    html = '<div class="empty-state"><div class="empty-icon">‚è≥</div><div>No attendance yet</div></div>';
                } else {
                    html = todayAttendance.map(att => `
                        <div class="attendance-item">
                            <div class="student-info">
                                <div class="student-roll">${att.rollNo}</div>
                                <div class="student-name">${att.name}</div>
                                <div class="student-time">${att.time}</div>
                            </div>
                            <button class="delete-btn" onclick="deleteAttendance('${key}', '${att.rollNo}')">Delete</button>
                        </div>
                    `).join('');
                }

                document.getElementById('attendance-list-container').innerHTML = html;
                document.getElementById('present-count').textContent = todayAttendance.length;
                document.getElementById('total-count').textContent = STUDENTS.length;
            });
        }

        function deleteAttendance(key, rollNo) {
            if (confirm('Delete this attendance record?')) {
                database.ref('attendance/' + key).orderByChild('rollNo').equalTo(rollNo).once('value', (snapshot) => {
                    snapshot.forEach((child) => {
                        child.ref.remove();
                    });
                });
            }
        }

        function submitAttendance() {
            const roll = document.getElementById('student-roll').value.trim().toUpperCase();
            const student = STUDENTS.find(s => s.rollNo.toUpperCase() === roll);
            const msgDiv = document.getElementById('modal-message');

            if (!student) {
                msgDiv.innerHTML = '<div class="message error">‚ùå Invalid Roll Number</div>';
                document.getElementById('student-roll').value = '';
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const key = code;

            database.ref('attendance/' + key).orderByChild('rollNo').equalTo(student.rollNo).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    msgDiv.innerHTML = '<div class="message error">‚ö†Ô∏è Already marked for today!</div>';
                    document.getElementById('student-roll').value = '';
                    return;
                }

                const newAttendanceRef = database.ref('attendance/' + key).push();
                newAttendanceRef.set({
                    rollNo: student.rollNo,
                    name: student.name,
                    time: new Date().toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
                    timestamp: Date.now()
                }).then(() => {
                    msgDiv.innerHTML = `<div class="message success">‚úì Attendance marked for ${student.name}!</div>`;
                    document.getElementById('student-roll').value = '';
                    setTimeout(() => closeModal(), 2000);
                }).catch((error) => {
                    msgDiv.innerHTML = '<div class="message error">‚ùå Error: ' + error.message + '</div>';
                });
            });
        }

        function downloadAttendance() {
            if (!currentSubject) {
                alert('‚ö†Ô∏è Please select a subject first');
                return;
            }

            // Check if XLSX is loaded
            if (typeof XLSX === 'undefined') {
                alert('‚ùå Excel library not loaded. Please refresh the page and try again.');
                console.error('XLSX library is not loaded');
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            const key = `${today}_${currentSubject.code}`;

            database.ref('attendance/' + key).once('value', (snapshot) => {
                const data = snapshot.val();
                const todayAttendance = data ? Object.values(data) : [];

                if (todayAttendance.length === 0) {
                    alert('‚ö†Ô∏è No attendance records to download for today');
                    return;
                }

                // Create Excel data with all students
                const excelData = STUDENTS.map(student => {
                    const attendanceRecord = todayAttendance.find(att => att.rollNo === student.rollNo);
                    return {
                        'Roll No': student.rollNo,
                        'Name': student.name,
                        'Status': attendanceRecord ? 'Present' : 'Absent',
                        'Time': attendanceRecord ? attendanceRecord.time : '-'
                    };
                });

                try {
                    // Create worksheet
                    const ws = XLSX.utils.json_to_sheet(excelData);
                    
                    // Set column widths
                    ws['!cols'] = [
                        { wch: 15 },  // Roll No
                        { wch: 30 },  // Name
                        { wch: 10 },  // Status
                        { wch: 12 }   // Time
                    ];

                    // Create workbook
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Attendance");

                    // Generate filename
                    const filename = `Attendance_${currentSubject.code}_${today}.xlsx`;

                    // Download file
                    XLSX.writeFile(wb, filename);
                    
                    alert(`‚úì Excel file downloaded successfully!\nPresent: ${todayAttendance.length}/${STUDENTS.length}`);
                } catch (error) {
                    console.error('Download error:', error);
                    alert('‚ùå Error downloading file: ' + error.message);
                }
            }).catch(error => {
                console.error('Database error:', error);
                alert('‚ùå Error fetching attendance data: ' + error.message);
            });
        }

        function renderHistory() {
            const container = document.getElementById('history-container');
            
            database.ref('attendance').once('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìä</div><div>No attendance records yet</div></div>';
                    return;
                }

                const grouped = {};
                Object.entries(data).forEach(([key, records]) => {
                    const [date, subject] = key.split('_');
                    const subj = SUBJECTS.find(s => s.code === subject);
                    if (!grouped[subject]) grouped[subject] = [];
                    const recordsArray = Object.values(records);
                    grouped[subject].push({ date, records: recordsArray, subject });
                });

                let html = '';
                Object.entries(grouped).forEach(([subject, entries]) => {
                    html += `<h3 style="margin-top: 24px; margin-bottom: 12px; font-size: 14px;"><span class="subject-badge">${subject}</span></h3>`;
                    entries.forEach(entry => {
                        html += `<div style="background: #1e293b; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                            <div style="font-weight: 600; margin-bottom: 4px;">üìÖ ${entry.date}</div>
                            <div style="font-size: 13px; color: #94a3b8;">üë• ${entry.records.length} students present</div>
                        </div>`;
                    });
                });

                if (html === '') {
                    html = '<div class="empty-state"><div class="empty-icon">üìä</div><div>No attendance records yet</div></div>';
                }

                container.innerHTML = html;
            });
        }

        function switchTab(tabName, event) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tabName === 'history-tab') {
                renderHistory();
            }
        }

        function closeModal() {
            document.getElementById('student-modal').classList.remove('active');
            document.getElementById('modal-message').innerHTML = '';
        }

        function openInfoModal() {
            document.getElementById('info-modal').classList.add('active');
        }

        function closeInfoModal() {
            document.getElementById('info-modal').classList.remove('active');
        }

        document.addEventListener('click', (e) => {
            const infoModal = document.getElementById('info-modal');
            if (e.target === infoModal) {
                closeInfoModal();
            }
        });

        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>